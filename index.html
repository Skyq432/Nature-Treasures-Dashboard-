<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Natures Treasure — Weekly Content Approval</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#f8f9fa,#e9ecef);min-height:100vh;color:#333}
    .container{max-width:1200px;margin:0 auto;padding:20px}

    /* Header */
    .header{background:linear-gradient(135deg,#093921,#0f4a2b);color:#fff;padding:18px;border-radius:14px;margin-bottom:18px;box-shadow:0 8px 32px rgba(9,57,33,.25)}
    .header-inner{display:flex;align-items:center;gap:20px;justify-content:flex-start;flex-wrap:wrap}
    .header-inner img{height:80px;width:auto;object-fit:cover;border-radius:8px;background:#fff;padding:4px;box-shadow:0 2px 6px rgba(0,0,0,.2)}
    .header-inner .title{text-align:center;flex:1}
    .header-inner h1{margin:0;font-weight:600;font-size:1.3rem}
    .header-inner p{margin-top:6px;font-size:.95rem;opacity:.9}

    /* Progress */
    .progress-tracker{background:#fff;padding:18px;border-radius:14px;margin-bottom:18px;box-shadow:0 4px 20px rgba(0,0,0,.08)}
    .progress-top{display:flex;gap:16px;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap}
    .stats{display:flex;gap:20px;align-items:center}
    .stat{text-align:center}
    .stat-number{font-size:1.6rem;font-weight:700;margin-bottom:2px}
    .approved{color:#093921}.pending{color:#f39c12}.rejected{color:#810000}
    .stat-label{font-size:.8rem;color:#666;letter-spacing:.3px;text-transform:uppercase}
    .progress-bar{width:100%;height:8px;background:#e9ecef;border-radius:999px;overflow:hidden}
    .progress-fill{height:100%;background:linear-gradient(90deg,#093921,#28a745);transition:width .3s ease}

    /* Actions */
    .actions{background:#fff;padding:12px;border-radius:14px;margin-bottom:18px;box-shadow:0 4px 20px rgba(0,0,0,.08);display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .actions .spacer{flex:1}
    .btn{padding:10px 18px;border:none;border-radius:10px;font-weight:600;cursor:pointer;transition:.2s;font-size:.9rem;display:inline-flex;align-items:center;gap:8px;text-decoration:none}
    .btn-approve{background:#093921;color:#fff}.btn-approve:hover{background:#0f4a2b}
    .btn-reject{background:#810000;color:#fff}.btn-reject:hover{background:#a50000}
    .btn-secondary{background:#f8f9fa;color:#093921;border:2px solid #093921}.btn-secondary:hover{background:#093921;color:#fff}
    .btn-quiet{background:#f1f5f2;color:#0f4a2b;border:1px solid #dbe7e1}
{opacity:.85;cursor:default}

    /* Grid + cards */
    .content-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:20px;margin-bottom:20px}
    .content-card{background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.08);transition:.2s}
    .content-card:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(0,0,0,.12)}
    .card-header{padding:14px;background:linear-gradient(135deg,#f8f9fa,#e9ecef);border-bottom:1px solid #dee2e6;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .day-badge{background:#093921;color:#fff;padding:6px 12px;border-radius:999px;font-size:.8rem;font-weight:700}
    .content-type{padding:3px 8px;border-radius:8px;font-size:.75rem;font-weight:700;letter-spacing:.3px;text-transform:uppercase}
    .post{background:#e3f2fd;color:#1976d2}.carousel{background:#f3e5f5;color:#7b1fa2}.video{background:#fff3e0;color:#f57c00}
    .card-content{padding:14px}

    .preview-wrap{position:relative}
    .content-preview{background:#f8f9fa;border:2px dashed #dee2e6;border-radius:8px;height:220px;display:flex;align-items:center;justify-content:center;margin-bottom:12px;overflow:hidden}
    .content-preview img,.content-preview iframe{max-width:100%;max-height:100%;border:0}
    .preview-actions{position:absolute;right:8px;top:8px;display:flex;gap:8px}
    .icon-btn{background:#ffffff; border:1px solid #dfe7e2; border-radius:999px; padding:7px; font-weight:700; cursor:pointer; text-decoration: none; color: #000000; font-size: 12px;}
    .icon-btn:hover{background:#eaf5ef}

    .content-description{font-size:.95rem;color:#555;line-height:1.6;margin-bottom:12px}
    .card-actions{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
    .btn-small{padding:8px 12px;font-size:.85rem}
    .status-badge{padding:6px 12px;border-radius:999px;font-size:.8rem;font-weight:700;text-align:center}
    .status-approved{background:#d4edda;color:#155724}
    .status-pending{background:#fff3cd;color:#856404}
    .status-rejected{background:#f8d7da;color:#721c24}

    /* Comment */
    .comment-toggle{font-size:.85rem;color:#0f4a2b;cursor:pointer;text-decoration:underline;margin-top:8px;display:inline-block}
    .comment-section{margin-top:10px;padding-top:10px;border-top:1px solid #dee2e6;display:none}
    .comment-input{width:100%;padding:10px;border:1px solid #dee2e6;border-radius:8px;resize:vertical;min-height:60px;font-family:inherit;font-size:.9rem}
    .comment-input:focus{outline:none;border-color:#093921;box-shadow:0 0 0 2px rgba(9,57,33,.1)}

    /* Footer */
    .site-footer{background:linear-gradient(135deg,#093921,#0f4a2b);color:#e8f3ed;border-radius:14px;box-shadow:0 8px 32px rgba(9,57,33,.25);margin-top:22px;overflow:hidden}
    .footer-inner{max-width:1200px;margin:0 auto;padding:22px 20px;display:grid;grid-template-columns:1.2fr .9fr .9fr;gap:18px}
    .footer-brand h4{font-size:1.05rem;font-weight:700;margin-bottom:8px}
    .footer-brand p{opacity:.9;line-height:1.5;font-size:.95rem}
    .footer-col h5{font-size:.95rem;font-weight:700;margin-bottom:10px}
    .footer-list{list-style:none;display:grid;gap:8px;font-size:.95rem}
    .footer-link{color:#e8f3ed;text-decoration:none;opacity:.95}
    .footer-link:hover{text-decoration:underline;opacity:1}
    .footer-meta{border-top:1px solid rgba(255,255,255,.15);padding:12px 20px;display:flex;gap:12px;justify-content:space-between;align-items:center;font-size:.9rem;background:rgba(0,0,0,.06);flex-wrap:wrap}
    .footer-cta{display:flex;gap:10px;flex-wrap:wrap}
    .footer-btn{background:#eaf5ef;color:#0f4a2b;border:0;border-radius:999px;padding:9px 14px;font-weight:700;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
    .footer-btn:hover{background:#dff0e7}
    .more-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap; justify-content: center;}
    .pill{padding:8px 12px;border-radius:999px;border:2px solid #eaf5ef;background:transparent;color:#0f4a2b;font-weight:700;cursor:pointer;}
    .pill.primary{background:#eaf5ef;color:#0f4a2b;border-color:#eaf5ef}


    /* Card Loader */
.card-loader{
  position:absolute;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:rgba(255,255,255,0.95);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  border-radius:14px;
  z-index:10;
  backdrop-filter:blur(2px);
}
.card-loader.hidden{
  display:none;
}
.loader-spinner{
  width:40px;
  height:40px;
  border:3px solid #e9ecef;
  border-top:3px solid #093921;
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin-bottom:12px;
}
.loader-text{
  color:#093921;
  font-size:0.9rem;
  font-weight:600;
  text-align:center;
}
@keyframes spin{
  0%{transform:rotate(0deg)}
  100%{transform:rotate(360deg)}
}

    @media(max-width:768px){
      .content-grid{grid-template-columns:1fr}
      .footer-inner{grid-template-columns:1fr}
      .footer-meta{flex-direction:column;align-items:flex-start}
    }

    /* Compact view */
    body.compact .content-description{display:none}
    body.compact .content-preview{height:140px}

    /* Fullscreen screen (replaces modal) */
    .screen{position:fixed;inset:0;background:#0b1e13;color:#eaf5ef;display:none;z-index:2000}
    .screen-inner{max-width:820px;margin:0 auto;padding:24px}
    .screen h2{font-size:1.25rem;margin-bottom:10px}
    .screen p{opacity:.95;line-height:1.7;margin:8px 0}
    .screen-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .screen-btn{padding:10px 14px;border-radius:10px;border:2px solid #eaf5ef;background:transparent;color:#eaf5ef;font-weight:700;cursor:pointer}
    .screen-btn.primary{background:#eaf5ef;color:#0b1e13;border-color:#eaf5ef}
    .screen-body{background:#103d26;border:1px solid #2a6a45;border-radius:12px;padding:14px;margin-top:12px;max-height:60vh;overflow:auto;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:.9rem;white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="container">

    <!-- Header -->
    <div class="header">
      <div class="header-inner">
        <img src="https://raw.githubusercontent.com/Skyq432/natures-treasure-approval/main/IMG-20250618-WA0003%282%29.jpg" alt="Natures Treasure Logo"/>
        <div class="title">
          <h1>Natures Treasure  Weekly Content Approval</h1>
          <p>Review and approve your social media content for the week</p>
        </div>
      </div>
    </div>

    <!-- Progress -->
    <div class="progress-tracker">
      <div class="progress-top">
        <div class="stats">
          <div class="stat"><div class="stat-number approved" id="approved-count">0</div><div class="stat-label">Approved</div></div>
          <div class="stat"><div class="stat-number pending" id="pending-count">0</div><div class="stat-label">Pending</div></div>
          <div class="stat"><div class="stat-number rejected" id="rejected-count">0</div><div class="stat-label">Rejected</div></div>
        </div>
        <div id="progressPct" class="stat-label">0%</div>
      </div>
      <div class="progress-bar"><div id="progress-fill" class="progress-fill" style="width:0%"></div></div>
    </div>

    <!-- Quick Actions -->
    <div class="actions">
      <button class="btn btn-approve" onclick="bulkApprove()">✓ Approve All Pending</button>
      <button class="btn btn-reject" onclick="bulkReject()">✗ Reject All Pending</button>
      <!-- <button class="btn btn-secondary" onclick="toggleCompact()">Compact View</button> -->
      <div class="spacer"></div>
   

    <!-- Content -->
    <div class="content-grid" id="content-grid"></div>

    <div class="more-row">
            <span>Do you have more to say? (Sky Q can call or meet physically)</span>
            <button class="pill primary" onclick="requestContact('yes')">Yes</button>
            <button class="pill" onclick="requestContact('no')">No</button>
          </div>

    <!-- Footer -->
    <footer class="site-footer">
      <div class="footer-inner">
        <div class="footer-brand">
          <h4>Content from Sky Q</h4>
          <p>Weekly content approval made simple. Review visuals, approve in one click, and keep your brand consistent across every channel.</p>
        </div>
        <div class="footer-col">
          <h5>Contact</h5>
          <ul class="footer-list">
            <li><a class="footer-link" href="tel:+2347026710999">Call: 07026710999</a></li>
            <li><a class="footer-link" href="https://wa.me/2347026710999" target="_blank" rel="noopener">WhatsApp: 07026710999</a></li>
          </ul>
        </div>
        <div class="footer-col">
          <h5>Quick actions</h5>
          <ul class="footer-list">
            <li><a class="footer-link" href="javascript:void(0)" onclick="bulkApprove()">Approve all pending</a></li>
            <li><a class="footer-link" href="javascript:void(0)" onclick="bulkReject()">Reject all pending</a></li>
            <li><a class="footer-link" href="javascript:void(0)" onclick="toggleCompact()">Compact view</a></li>
          </ul>
        </div>
      </div>
      
      <div class="footer-meta">
        <small>&copy; <span id="year"></span> Sky Q. All rights reserved.</small>
        <div class="footer-cta">
          
        </div>
      </div>
    </footer>

  </div>

  <!-- Full Screen screen (replaces modal) -->
  <div id="screen" class="screen" aria-hidden="true">
    <div class="screen-inner">
      <h2 id="screen-title">Saved</h2>
      <p id="screen-desc">Your decisions have been saved successfully.</p>
      <div class="screen-actions">
        <button class="screen-btn primary" onclick="closeScreen()">Close</button>
        <button class="screen-btn" id="screen-download" onclick="downloadLastPayload()">Download JSON</button>
      </div>
      <div class="screen-body" id="screen-body"></div>
    </div>
  </div>

<script>
/* =========================
   CONFIG
   ========================= */
const SCRIPT_BASE = 'https://script.google.com/macros/s/AKfycbwL38tROtxr_MBb71-kZxVtx3aQBglCpye7cX0Z-aynwsGnIOhg3hyQ3VhhWTxKWkRS/exec';

/* =========================
   STATE
   ========================= */
let activeWeek = '';
let currentWeek = '';
let items = [];
let isSubmitted = false;
let lastSubmitPayload = null;

/* =========================
   HELPERS
   ========================= */
const qs = s => document.querySelector(s);
function cap(s){ return (s||'').charAt(0).toUpperCase()+String(s||'').slice(1); }
function parseYMD(s){ const [y,m,d]=String(s||'').split('-').map(n=>parseInt(n,10)); if(!y||!m||!d) return null; return new Date(y,m-1,d); }
function download(filename, text){
  const blob = new Blob([text], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=filename;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* =========================
   API
   ========================= */
async function apiGet(path){
  const res = await fetch(`${SCRIPT_BASE}${path}`);
  if(!res.ok) throw new Error('Network error'); return res.json();
}
async function apiPost(payload){
  const res = await fetch(SCRIPT_BASE, {
    method:'POST',
    headers:{ 'Content-Type':'text/plain;charset=utf-8' }, // avoid preflight
    body: JSON.stringify(payload)
  });
  if(!res.ok) throw new Error('Network error'); return res.json();
}

/* =========================
   MEDIA (embed + carousel)
   ========================= */
function extractDriveId(url){
  const s = String(url||'');
  let m=s.match(/\/d\/([a-zA-Z0-9_-]+)/); if(m) return m[1];
  m=s.match(/[?&]id=([a-zA-Z0-9_-]+)/);   if(m) return m[1];
  return null;
}
function makeDownloadLink(link){
  const id = extractDriveId(link);
  return id ? `https://drive.google.com/uc?export=download&id=${id}` : link;
}
function toEmbedHTML(link, type){
  const url = String(link||'').trim();
  const safe = url.replace(/"/g,'&quot;');
  const lowerType = String(type||'post').toLowerCase();

  if (url.includes('drive.google.com/drive/folders/')) {
    return `<a href="${safe}" target="_blank" rel="noopener">Open Drive folder</a>`;
  }
  const id = extractDriveId(url);

  if (!id){
    return `<img src="${safe}" alt="media" loading="lazy" decoding="async"
            onerror="this.outerHTML='<a href=&quot;${safe}&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;>Open link</a>'">`;
  }
  if (lowerType==='video' || url.includes('/preview')){
    return `<iframe src="https://drive.google.com/file/d/${id}/preview" loading="lazy" allow="autoplay" allowfullscreen></iframe>`;
  }
  const imgSrc = `https://drive.google.com/uc?export=view&id=${id}`;
  const iframeSrc = `https://drive.google.com/file/d/${id}/preview`;
  
  const onErr = `this.outerHTML='<iframe src=&quot;${iframeSrc}&quot; loading=&quot;lazy&quot; allow=&quot;autoplay&quot;  allowfullscreen ></iframe>'`;
  return `<img src="${imgSrc}" alt="media" loading="lazy" decoding="async" onerror="${onErr}">`;
}
function toCarouselHTML(links, type, containerId){
  const trackId = containerId + '-track';
  const slides = links.map(l => `
    <div style="flex:0 0 100%; height:100%; scroll-snap-align:center; display:flex; align-items:center; justify-content:center; background:#fff; border:1px solid #eee; border-radius:8px; overflow:hidden">
      ${toEmbedHTML(l, type)}
    </div>`).join('');
  const dl = links.length ? makeDownloadLink(links[0]) : '#';
  return `
    <div class="preview-actions">
      <button class="icon-btn" onclick="goFullscreen('${trackId}')">Fullscreen</button>
      ${links.length ? `<a class="icon-btn" href="${dl}" target="_blank" rel="noopener">Download</a>` : ''}
    </div>
    <div id="${trackId}" style="display:flex; gap:8px; height:100%; overflow-x:auto; scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch; padding:8px;">
      ${slides}
    </div>
    <div style="position:absolute; inset:0; display:flex; justify-content:space-between; align-items:center; pointer-events:none; padding:0 4px;">
      <button style="pointer-events:auto; background:rgba(0,0,0,.5); color:#fff; border:none; border-radius:999px; width:36px; height:36px; cursor:pointer" onclick="scrollCarousel('${trackId}',-1)">&lt;</button>
      <button style="pointer-events:auto; background:rgba(0,0,0,.5); color:#fff; border:none; border-radius:999px; width:36px; height:36px; cursor:pointer" onclick="scrollCarousel('${trackId}', 1)">&gt;</button>
    </div>`;
}
function scrollCarousel(id, dir){
  const el = document.getElementById(id); if(!el) return;
  const w = el.clientWidth; el.scrollBy({ left: dir*w, behavior:'smooth' });
}
function goFullscreen(elId){
  const el = document.getElementById(elId);
  if(!el) return;
  if (el.requestFullscreen) el.requestFullscreen();
}

/* =========================
   RENDER
   ========================= */
function statusClass(st){ if(st==='approved') return 'status-approved'; if(st==='rejected') return 'status-rejected'; return 'status-pending'; }
function getComment(id){ const el = document.getElementById(`comment-${id}`); return el ? el.value.trim() : ''; }

function renderCards(){
  const grid = document.getElementById('content-grid');
  grid.innerHTML = '';

  items.forEach((it, idx)=>{
    const type  = (it.type||'post').toLowerCase();
    const links = String(it.drive_urls||'').split(/[\n,]/).map(s=>s.trim()).filter(Boolean);
    const containerId = `preview-${String(it.id||idx)}`;

    let mediaInner = 'No media';
    if(type==='carousel' && links.length>1){
      mediaInner = toCarouselHTML(links, type, containerId);
    } else {
      const media = links[0];
      const dl = media ? makeDownloadLink(media) : '#';
      const content = media ? toEmbedHTML(media, type==='video' ? 'video' : 'post') : 'No media';
      mediaInner = `
        <div class="preview-actions">
          <button class="icon-btn" onclick="goFullscreen('${containerId}')">Fullscreen</button>
          ${media ? `<a class="icon-btn" href="${dl}" target="_blank" rel="noopener">Download</a>` : ''}
        </div>
        <div id="${containerId}" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;">${content}</div>`;
    }

    const card = document.createElement('div');
    card.className = 'content-card';
    card.innerHTML = `
    <div class="card-loader hidden" id="loader-${it.id}">
  <div class="loader-spinner"></div>
  <div class="loader-text">Processing...</div>
</div>
      <div class="card-header">
        <span class="day-badge">${it.day_label||''}</span>
        <span class="content-type ${type}">${type.toUpperCase()}</span>
      </div>
      <div class="card-content">
        <div class="preview-wrap">
          <div class="content-preview">${mediaInner}</div>
        </div>
        <div class="content-description">${(it.caption||'')}</div>
        <div class="card-actions">
          <button class="btn btn-approve btn-small" onclick="approveContent('${it.id}')">✓ Approve</button>
          <button class="btn btn-reject  btn-small" onclick="rejectContent('${it.id}')">✗ Reject</button>
        </div>
        <div class="status-badge ${statusClass(it.status)}" id="status-${it.id}">
          ${cap(it.status||'pending')}
        </div>
        <a class="comment-toggle" href="javascript:void(0)" onclick="toggleComment('${it.id}')" id="cmt-toggle-${it.id}">Add a comment</a>
        <div class="comment-section" id="comment-section-${it.id}">
          <textarea class="comment-input" id="comment-${it.id}" placeholder="Type your comment..."></textarea>
        </div>
      </div>`;
    grid.appendChild(card);

    const ta = card.querySelector(`#comment-${it.id}`);
    if (ta){
      ta.value = it.comment || '';
      ta.addEventListener('input', e=>{
        const v = e.target.value;
        debounce(`cmt-${it.id}`, ()=> saveComment(it.id, v), 500);
      });
    }
  });

  updateProgress();
}

/* =========================
   PROGRESS
   ========================= */
function updateProgress(){
  const a = items.filter(x=>x.status==='approved').length;
  const p = items.filter(x=>x.status==='pending').length;
  const r = items.filter(x=>x.status==='rejected').length;
  qs('#approved-count').textContent = a;
  qs('#pending-count').textContent  = p;
  qs('#rejected-count').textContent = r;
  const pct = Math.round((a/(items.length||1))*100);
  document.getElementById('progress-fill').style.width = pct+'%';
  document.getElementById('progressPct').textContent = pct+'%';
}
function updateCardStatus(id, status){
  const it = items.find(x=>String(x.id)===String(id)); if(!it) return;
  it.status = status;
  const badge = document.getElementById(`status-${id}`);
  if(badge){ badge.className = `status-badge ${statusClass(status)}`; badge.textContent = cap(status); }
  updateProgress();
}

/* =========================
   ACTIONS
   ========================= */
async function approveContent(id){
  const it = items.find(x=>String(x.id)===String(id)); if(!it) return;
  const prev = it.status; 
  
  showCardLoader(id, 'Approving...');
  updateCardStatus(id,'approved');
  
  try{
    const out = await apiPost({ route:'update_decision', id, status:'approved', comment:getComment(id) });
    if(!out.ok) throw new Error(out.reason||'Update failed');
  }catch(err){ 
    updateCardStatus(id, prev); 
    alert(err.message||'Could not approve.'); 
  } finally {
    hideCardLoader(id);
  }
}

async function rejectContent(id){
  const it = items.find(x=>String(x.id)===String(id)); if(!it) return;
  const prev = it.status; 
  
  showCardLoader(id, 'Rejecting...');
  updateCardStatus(id,'rejected');
  
  const sec = document.getElementById(`comment-section-${id}`);
  const link= document.getElementById(`cmt-toggle-${id}`);
  if(sec&&link){ sec.style.display='block'; link.textContent='Hide comment'; }
  
  try{
    const out = await apiPost({ route:'update_decision', id, status:'rejected', comment:getComment(id) });
    if(!out.ok) throw new Error(out.reason||'Update failed');
  }catch(err){ 
    updateCardStatus(id, prev); 
    alert(err.message||'Could not reject.'); 
  } finally {
    hideCardLoader(id);
  }
}

/* Debounced comment save */
const _deb = {};
function debounce(key, fn, delay=400){ clearTimeout(_deb[key]); _deb[key]=setTimeout(fn, delay); }
async function saveComment(id, comment){
  try{
    let out = await apiPost({ route:'update_comment', id, comment });
    if(!out.ok) throw new Error(out.reason||'Failed saving comment');
  }catch(err){ console.warn('Comment save failed:', err.message); }
}
function toggleComment(id){
  const sec = document.getElementById(`comment-section-${id}`);
  const link= document.getElementById(`cmt-toggle-${id}`);
  const show = sec.style.display!=='block';
  sec.style.display = show ? 'block' : 'none';
  link.textContent  = show ? 'Hide comment' : 'Add a comment';
}

/* Bulk */
async function bulkApprove(){
  const pend = items.filter(it=>it.status==='pending');
  pend.forEach(it => showCardLoader(it.id, 'Approving...'));
  pend.forEach(it=> updateCardStatus(it.id,'approved'));
  for(const it of pend){
    try{ await apiPost({ route:'update_decision', id:it.id, status:'approved', comment:getComment(it.id) }); }catch(e){}
  }
  pend.forEach(it => hideCardLoader(it.id));
  isSubmitted=false; syncSubmitBtn();
}
async function bulkReject(){
  const pend = items.filter(it=>it.status==='pending');
  pend.forEach(it => showCardLoader(it.id, 'Rejecting...'));
  pend.forEach(it=>{
    updateCardStatus(it.id,'rejected');
    const sec=document.getElementById(`comment-section-${it.id}`);
    const link=document.getElementById(`cmt-toggle-${it.id}`);
    if(sec&&link){ sec.style.display='block'; link.textContent='Hide comment'; }
  });
  for(const it of pend){
    try{ await apiPost({ route:'update_decision', id:it.id, status:'rejected', comment:getComment(it.id) }); }catch(e){}
  }
  pend.forEach(it => hideCardLoader(it.id));
  isSubmitted=false; syncSubmitBtn();
}

/* =========================
   SUBMIT (full-screen + optional download)
   ========================= */
async function submitAll(){
  if (!items.length){
    openScreen('Nothing to submit', 'Please review items and approve/reject, then submit.', { body:'', canDownload:false });
    return;
  }
  const payload = {
    week_start: currentWeek,
    totals: {
      approved: items.filter(x=>x.status==='approved').length,
      pending:  items.filter(x=>x.status==='pending').length,
      rejected: items.filter(x=>x.status==='rejected').length,
      total:    items.length
    },
    items: items.map(x=>({
      id:String(x.id), day_label:x.day_label||'', type:x.type||'',
      status:x.status||'pending', caption:x.caption||'',
      comment:getComment(x.id) || x.comment || '',
      drive_urls:x.drive_urls||''
    }))
  };
  try{
    const out = await apiPost({ route:'mark_week_done', payload });
    console.log(out);
    if(!out.ok) throw new Error(out.reason||'Could not submit');
    isSubmitted = true; syncSubmitBtn();
    lastSubmitPayload = payload;
    openScreen('Saved', 'Your decisions have been saved successfully.', {
      body: JSON.stringify(payload, null, 2),
      canDownload: true
    });
  }catch(err){
    isSubmitted = false; syncSubmitBtn();
    openScreen('Failed to submit', String(err.message||'Unknown error'), { body:'', canDownload:false });
  }
}
function syncSubmitBtn(){
  const btn = document.getElementById('submitBtn');
  if(!btn) return;
  if(isSubmitted){ btn.textContent='Saved'; btn.classList.add('saved'); btn.setAttribute('disabled',''); }
  else{ btn.textContent='Click to submit'; btn.classList.remove('saved'); btn.removeAttribute('disabled'); }
}

/* =========================
   FOOTER CONTACT REQUEST (Yes/No)
   ========================= */
async function requestContact(choice){
  try{
    if (choice === 'yes'){
      const out = await apiPost({ route:'contact_request', week_start: currentWeek, note: '' });
      if (!out.ok) throw new Error(out.reason||'Failed');
      openScreen('We’ll reach out', 'Sky Q will contact you via phone or arrange a physical meeting. Thank you!', { body:'', canDownload:false });
    } else {
      openScreen('Noted', 'No worries. If you change your mind, you can still click “Yes” later from the footer.', { body:'', canDownload:false });
    }
  }catch(err){
    openScreen('Could not update', String(err.message||'Unknown error'), { body:'', canDownload:false });
  }
}

/* =========================
   FULL SCREEN
   ========================= */
function openScreen(title, desc, opts={}) {
  const canDownload = !!opts.canDownload;
  qs('#screen-title').textContent = title || 'Notice';
  qs('#screen-desc').textContent  = desc   || '';
  qs('#screen-body').textContent  = opts.body || '';
  qs('#screen-download').style.display = canDownload ? 'inline-flex' : 'none';
  const s = qs('#screen'); s.style.display='block'; s.setAttribute('aria-hidden','false');
}
function closeScreen(){
  const s = qs('#screen'); s.style.display='none'; s.setAttribute('aria-hidden','true');
}
function downloadLastPayload(){
  if(!lastSubmitPayload) return;
  download(`natures-treasure-${currentWeek||'week'}.json`, JSON.stringify(lastSubmitPayload, null, 2));
}

/* =========================
   WEEK LOADERS
   ========================= */
async function loadActive(){
  const data = await apiGet('?route=content');
  activeWeek = data.active_week || data.week_start;
  currentWeek= data.week_start;
  items = (data.items||[]).map(n => ({
    ...n,
    id:String(n.id||''),
    status:String(n.status||'pending').toLowerCase()
  }));
  renderCards(); syncSubmitBtn();
}

/* =========================
   LOADER FUNCTIONS
   ========================= */
function showCardLoader(cardId, text = 'Processing...') {
  const loader = document.getElementById(`loader-${cardId}`);
  if (loader) {
    loader.querySelector('.loader-text').textContent = text;
    loader.classList.remove('hidden');
  }
}

function hideCardLoader(cardId) {
  const loader = document.getElementById(`loader-${cardId}`);
  if (loader) {
    loader.classList.add('hidden');
  }
}

/* =========================
   BOOT
   ========================= */
document.addEventListener('DOMContentLoaded', async ()=>{
  document.getElementById('year').textContent = new Date().getFullYear();
  await loadActive().catch(err=>{ console.error(err); alert('Could not load content'); });
});
</script>
</body>
</html>
